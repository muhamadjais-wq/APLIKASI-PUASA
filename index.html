<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Meta tags untuk iOS & Android Full Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Ramadan Executive - Corporate Gold Edition</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap');
        
        :root {
            --gold-primary: #d4af37;
            --gold-light: #f1d592;
            --corporate-black: #050505;
            --corporate-slate: #111827;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--corporate-black);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: #f1f5f9;
            letter-spacing: -0.01em;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Latar Belakang Abstrak Korporat */
        .main-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, rgba(212, 175, 55, 0.08) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(212, 175, 55, 0.05) 0, transparent 50%),
                linear-gradient(135deg, #050505 0%, #0a0a0a 50%, #020202 100%);
            z-index: -1;
        }

        /* Corak Geometrikal Halus */
        .main-bg::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(212, 175, 55, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 175, 55, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(ellipse at center, black, transparent 80%);
            opacity: 0.5;
        }

        /* Corporate Glassmorphism */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(40px) saturate(150%); 
            border: 1px solid rgba(212, 175, 55, 0.15); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
        }

        .text-gold { color: var(--gold-primary); }
        .border-gold { border-color: rgba(212, 175, 55, 0.3); }

        .timer-dashboard {
            position: relative;
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.2);
            background: rgba(10, 10, 10, 0.4);
        }

        .mood-dawn { background: linear-gradient(145deg, #0f172a, #020617); }
        .mood-morning { background: linear-gradient(145deg, #064e3b, #022c22); }
        .mood-midday { background: linear-gradient(145deg, #075985, #082f49); }
        .mood-afternoon { background: linear-gradient(145deg, #78350f, #451a03); }
        .mood-sunset { background: linear-gradient(145deg, #7f1d1d, #450a0a); animation: gold-pulse 2.5s infinite; }
        .mood-night { background: linear-gradient(145deg, #1e1b4b, #020617); }

        @keyframes gold-pulse {
            0%, 100% { box-shadow: 0 0 40px rgba(212, 175, 55, 0.1); }
            50% { box-shadow: 0 0 70px rgba(212, 175, 55, 0.3); }
        }

        /* Gaya Kad Waktu Solat */
        .card-Imsak { background: #111; border-color: #222; }
        .card-Fajr { background: #0c162d; border-color: #1e293b; }
        .card-Sunrise { background: #2a1b0a; border-color: #422006; }
        .card-Duha { background: #3d2b01; border-color: #d4af37; }
        .card-Dhuhr { background: #062a2a; border-color: #134e4a; }
        .card-Asr { background: #2a1506; border-color: #431407; }
        .card-Maghrib { background: #2d0a0a; border-color: #450a0a; }
        .card-Isha { background: #1a1a2e; border-color: #1e1b4b; }
        .card-Tahajjud { background: #1e113a; border-color: #8b5cf6; }

        @keyframes prayer-pulse {
            0% { transform: scale(1); border-color: var(--gold-primary); }
            50% { transform: scale(1.02); border-color: white; box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
            100% { transform: scale(1); border-color: var(--gold-primary); }
        }

        .denyut-aktif {
            animation: prayer-pulse 2s infinite ease-in-out;
            border: 2px solid var(--gold-primary) !important;
            z-index: 10;
        }

        .colorful-digit { display: inline-block; transition: color 0.5s ease; }

        .btn-premium:hover {
            background: rgba(212, 175, 55, 0.05);
            transform: translateY(-2px);
            border-color: var(--gold-primary);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.97);
            z-index: 1000;
            backdrop-filter: blur(30px);
            align-items: center;
            justify-content: center;
            padding: 24px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .arabic-text { font-family: 'Amiri', serif; font-size: 1.8rem; line-height: 2.2; text-align: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }

        .safe-padding {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #audio-status-msg {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #d4af37;
            color: black;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 900;
            z-index: 2000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid white;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen w-full">
    <div class="main-bg" id="dynamic-bg"></div>
    <div id="audio-status-msg">Sistem Suara Sedia</div>

    <div id="app" class="w-full max-w-lg px-5 safe-padding py-6 space-y-6 sm:space-y-10">
        
        <!-- Header -->
        <header class="flex justify-between items-center w-full pt-2">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 sm:w-16 sm:h-16 glass-panel rounded-2xl flex items-center justify-center border-gold shadow-2xl bg-black/20">
                    <i data-lucide="award" class="text-gold w-6 h-6 sm:w-8 sm:h-8"></i>
                </div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-white leading-none mb-1 text-shadow">Ramadan <span class="text-gold">Executive</span></h1>
                    <p id="current-date" class="text-slate-500 text-[9px] sm:text-[10px] font-black uppercase tracking-[0.35em]">Edition 2026</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openTasbih()" class="w-12 h-12 sm:w-14 sm:h-14 rounded-full glass-panel flex items-center justify-center hover:bg-white/5 transition-all border-emerald-500/30">
                    <i data-lucide="fingerprint" class="w-5 h-5 sm:w-6 sm:h-6 text-emerald-400"></i>
                </button>
                <button onclick="toggleAudio()" id="audio-btn" class="w-12 h-12 sm:w-14 sm:h-14 rounded-full glass-panel flex items-center justify-center hover:bg-white/5 transition-all active:scale-95 shadow-lg border-gold">
                    <i data-lucide="volume-x" class="w-5 h-5 sm:w-6 sm:h-6 text-red-500" id="audio-icon"></i>
                </button>
            </div>
        </header>

        <!-- Inspiration Panel -->
        <div class="glass-panel p-4 sm:p-6 rounded-[1.5rem] border-gold/10 relative overflow-hidden group bg-black/40">
            <div class="absolute -right-4 -top-4 opacity-10 group-hover:rotate-12 transition-transform duration-700">
                <i data-lucide="quote" class="w-20 h-20 text-gold"></i>
            </div>
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="lightbulb" class="w-3 h-3 text-gold"></i>
                <span class="text-[8px] font-black uppercase tracking-[0.2em] text-gold/60 italic">Daily Inspiration</span>
            </div>
            <p id="daily-hadith" class="text-xs sm:text-sm font-medium text-slate-300 leading-relaxed italic relative z-10">"Barangsiapa berpuasa Ramadan kerana iman dan mengharap pahala, diampuni dosanya."</p>
        </div>

        <!-- Search -->
        <div class="w-full relative">
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                    <input type="text" id="location-input" placeholder="Cari Daerah atau Negeri..." 
                        class="w-full bg-black/60 border border-gold/20 rounded-2xl py-4 pl-12 text-sm font-medium text-white focus:ring-1 focus:ring-gold outline-none backdrop-blur-md">
                </div>
                <button onclick="initLocation()" class="w-12 h-12 glass-panel rounded-2xl flex items-center justify-center text-gold active:scale-90 transition-all bg-black/40">
                    <i data-lucide="navigation" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="search-results" class="hidden absolute z-50 w-full mt-2 glass-panel rounded-2xl shadow-3xl max-h-60 overflow-y-auto border-gold/20 bg-black/90"></div>
        </div>

        <!-- Timer Dashboard -->
        <div id="main-timer-card" class="timer-dashboard rounded-[2.5rem] p-8 sm:p-12 text-center mood-morning shadow-2xl border-white/10 border bg-black/20">
            <div id="timer-progress" class="absolute bottom-0 left-0 h-1 bg-gold transition-all duration-1000" style="width: 0%"></div>
            
            <div class="relative z-10">
                <p id="next-label" class="text-gold/60 text-[9px] font-black uppercase mb-4 italic tracking-widest">Next Analysis</p>
                <h2 id="next-time" class="text-6xl sm:text-8xl font-black tracking-tighter mb-1 text-white">--:--</h2>
                <div id="countdown" class="text-lg font-light font-mono text-white/50 tracking-[0.3em] mb-6 uppercase">--:--:--</div>
                
                <div class="flex flex-col items-center mb-8">
                    <span class="text-[8px] text-gold/40 uppercase font-black tracking-[0.2em] mb-1">Live Global Time</span>
                    <div id="real-time-clock" class="text-3xl sm:text-4xl font-extrabold tracking-widest bg-black/60 py-3 px-8 rounded-xl border border-gold/10 shadow-inner"></div>
                </div>
                
                <div id="location-panel" class="location-badge rounded-2xl p-5 flex justify-between items-center backdrop-blur-xl bg-black/30">
                    <div class="text-left space-y-0.5">
                        <span class="text-[8px] text-gold/40 uppercase font-black">Region</span>
                        <p id="location-district" class="font-bold text-sm text-white tracking-tight">Detecting...</p>
                    </div>
                    <div class="h-8 w-[1px] bg-gold/10 mx-2"></div>
                    <div class="text-right space-y-0.5">
                        <span class="text-[8px] text-gold/40 uppercase font-black">State</span>
                        <p id="location-state" class="font-bold text-sm text-white tracking-tight">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Grid -->
        <div class="grid grid-cols-5 gap-1.5 sm:gap-2">
            <button onclick="openDua('berbuka_sendiri')" class="glass-panel p-2 rounded-xl flex flex-col items-center gap-2 active:scale-95 bg-black/20">
                <i data-lucide="user" class="text-gold w-4 h-4"></i>
                <span class="text-[7px] font-black text-white uppercase">Solo</span>
            </button>
            <button onclick="openDua('berbuka_ramai')" class="glass-panel p-2 rounded-xl flex flex-col items-center gap-2 active:scale-95 bg-black/20">
                <i data-lucide="users" class="text-slate-300 w-4 h-4"></i>
                <span class="text-[7px] font-black text-white uppercase">Group</span>
            </button>
            <button onclick="openDua('niat_puasa')" class="glass-panel p-2 rounded-xl flex flex-col items-center gap-2 active:scale-95 bg-black/20">
                <i data-lucide="shield-check" class="text-gold w-4 h-4"></i>
                <span class="text-[7px] font-black text-white uppercase">Niat</span>
            </button>
            <button onclick="openAzanSelector()" class="glass-panel p-2 rounded-xl flex flex-col items-center gap-2 border-gold/30 active:scale-95 bg-black/20">
                <i data-lucide="music" class="text-emerald-400 w-4 h-4"></i>
                <span class="text-[7px] font-black text-white uppercase">Azan</span>
            </button>
            <button onclick="openPrayerCollection()" class="glass-panel p-2 rounded-xl flex flex-col items-center gap-2 border-gold active:scale-95 bg-gold/10 shadow-[0_0_15px_rgba(212,175,55,0.2)]">
                <i data-lucide="book-open" class="text-gold w-4 h-4"></i>
                <span class="text-[7px] font-black text-white uppercase">Doa</span>
            </button>
        </div>

        <!-- Prayer List -->
        <div class="space-y-3 sm:space-y-4 pb-24" id="prayer-list"></div>
    </div>

    <!-- Modals -->
    <div id="dua-modal" class="modal-overlay" onclick="closeModal()">
        <div class="glass-panel w-full max-w-lg rounded-[2.5rem] p-8 text-center border-gold/20 bg-black/95" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-8 right-8 p-2 text-slate-500"><i data-lucide="x"></i></button>
            <div id="dua-content" class="space-y-8 overflow-y-auto max-h-[60vh] custom-scroll"></div>
            <div class="mt-8">
                <button id="tts-btn" class="w-full bg-gold py-5 rounded-2xl font-bold text-xs uppercase flex items-center justify-center gap-4 text-black active:scale-95 shadow-xl">
                    <i data-lucide="play-circle" class="w-5 h-5"></i> Bimbingan Audio AI
                </button>
            </div>
        </div>
    </div>

    <div id="collection-modal" class="modal-overlay" onclick="closeCollectionModal()">
        <div class="glass-panel w-full max-w-lg rounded-[3rem] p-8 bg-black/95 border-gold/20" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-8 border-b border-gold/10 pb-4">
                <div>
                    <h3 class="text-xl font-bold text-gold uppercase tracking-widest">Hub Doa Intelektual</h3>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Himpunan 20 Amalan Penuh Rasulullah SAW</p>
                </div>
                <button onclick="closeCollectionModal()" class="text-slate-500"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-3 overflow-y-auto max-h-[65vh] pr-2 custom-scroll" id="prayer-collection-list"></div>
        </div>
    </div>

    <div id="tasbih-modal" class="modal-overlay" onclick="closeTasbih()">
        <div class="glass-panel w-full max-w-lg rounded-[2.5rem] p-8 text-center border-emerald-500/20 bg-black/95" onclick="event.stopPropagation()">
            <button onclick="closeTasbih()" class="absolute top-8 right-8 p-2 text-slate-500"><i data-lucide="x"></i></button>
            <div id="tasbih-count" class="text-7xl font-black text-white mb-6">0</div>
            <button onclick="incrementTasbih()" class="w-32 h-32 mx-auto bg-emerald-600 rounded-full flex items-center justify-center border-4 border-white/20 active:scale-90 transition-all shadow-xl"><i data-lucide="plus" class="text-white w-12 h-12"></i></button>
            <button onclick="resetTasbih()" class="mt-10 text-[9px] font-black uppercase text-slate-500 tracking-[0.2em]">Reset Counter</button>
        </div>
    </div>

    <div id="azan-modal" class="modal-overlay" onclick="closeAzanModal()">
        <div class="glass-panel w-full max-w-lg rounded-[2.5rem] p-8 bg-black/95 border-gold/20" onclick="event.stopPropagation()">
            <button onclick="closeAzanModal()" class="absolute top-8 right-8 text-slate-500"><i data-lucide="x"></i></button>
            <h3 class="text-xl font-bold text-white text-center mb-8 uppercase tracking-widest text-gold italic">Alunan Azan Pilihan</h3>
            <div class="space-y-3" id="azan-options-list"></div>
        </div>
    </div>

    <audio id="main-audio-player" style="display:none"></audio>
    <audio id="preview-audio-player" style="display:none"></audio>

    <script>
        const apiKey = "";
        let audioEnabled = false;
        let prayerTimes = null;
        let audioCtx = null;
        let locationData = { lat: 3.1390, lon: 101.6869, district: 'Kuala Lumpur', state: 'Wilayah' };
        let tasbihCount = 0;
        let searchTimeout = null;

        const prayerNames = { 'Imsak': 'Imsak', 'Fajr': 'Subuh', 'Sunrise': 'Syuruk', 'Duha': 'Solat Duha', 'Dhuhr': 'Zohor', 'Asr': 'Asar', 'Maghrib': 'Maghrib', 'Isha': 'Isyak', 'Tahajjud': 'Solat Tahajjud' };
        const clockColors = ['#d4af37', '#e5e7eb', '#cd7f32', '#94a3b8', '#f1d592', '#ffffff'];

        const prayerCollection = [
            { id: 'doa_duha', title: "Doa Solat Duha (Lengkap)", arab: "اَللّٰهُمَّ اِنَّ الضُّحَآءَ ضُحَاءُكَ وَالْبَهَاءَ بَهَاءُكَ وَالْجَمَالَ جَمَالُكَ وَالْقُوَّةَ قُوَّتُكَ وَالْقُدْرَةَ قُدْرَتُكَ وَالْعِصْمَةَ عِصْمَتُكَ. اَللّٰهُمَّ اِنْ كَانَ رِزْقِى فِى السَّمَآءِ فَأَنْزِلْهُ وَاِنْ كَانَ فِى اْلاَرْضِ فَأَخْرِجْهُ وَاِنْ كَانَ مُعَسَّرًا فَيَسِّرْهُ وَاِنْ كَانَ حَرَامًا فَطَهِّرْهُ وَاِنْ كَانَ بَعِيْدًا fَقَرِّبْهُ بِحَقِّ ضُحَاءِكَ وَبَهَاءِكَ وَجَمَالِكَ وَقُوَّتِكَ وَقُدْرَتِكَ آتِنِىْ مَآاَتَيْتَ عِبَادَكَ الصَّالِحِيْنَ", rumi: "Allahumma inna ad-duha'a duha'uka, wal-baha'a baha'uka, wal-jamala jamaluka, wal-quwwata quwwatuka, wal-qudrata qudratuka, wal-'ismata 'ismatuka. Allahumma in kana rizqi fis-sama'i fa-anzilhu, wa-in kana fil-ardi fa-akhrijhu, wa-in kana mu'assaran fa-yassirhu, wa-in kana haraman fa-tahhirhu, wa-in kana ba'idan fa-qarribhu bi-haqqi duha'ika wa-baha'ika wa-jamalika wa-quwwatika wa-qudratika, atini ma ataita 'ibadakas-salihin.", maksud: "Ya Allah, sesungguhnya waktu Duha itu adalah waktu Duha-Mu, keagungan itu keagungan-Mu, keindahan itu keindahan-Mu, kekuatan itu kekuatan-Mu, kekuasaan itu kekuasaan-Mu dan penjagaan itu penjagaan-Mu. Ya Allah, jika rezekiku di langit maka turunkanlah, jika di bumi maka keluarkanlah, jika sukar maka mudahkanlah, jika haram maka sucikanlah, jika jauh maka dekatkanlah..." },
            { id: 'lailatul_qadar', title: "Doa Lailatul Qadar (Aisyah RA)", arab: "اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي", rumi: "Allahumma innaka 'afuwwun tuhibbul 'afwa fa'fu 'anni.", maksud: "Ya Allah, sesungguhnya Engkau Maha Pengampun dan amat menyukai keampunan, maka ampunilah aku." },
            { id: 'sayyidul_istighfar', title: "Sayyidul Istighfar (Penghulu Istighfar)", arab: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ خَلَقْتَنِي وَأَنَا عَبْدُكَ وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ أَبُوءُ لَكَ bini'matika 'alayya wa abu'u bidhanbi faghfirli...", rumi: "Allahumma anta Rabbi la ilaha illa anta, khalaqtani wa ana 'abduka, wa ana 'ala 'ahdika wa wa'dika mastata'tu. A'udhu bika min sharri ma sana'tu, abu'u laka bi ni'matika 'alayya, wa abu'u laka bi dhanbi faghfir li...", maksud: "Ya Allah, Engkau adalah Tuhanku, tidak ada Tuhan yang berhak disembah selain Engkau. Engkau yang menciptakanku dan aku adalah hamba-Mu..." },
            { id: 'nabi_yunus', title: "Zikir Nabi Yunus (Pelepas Kesulitan)", arab: "لَا إِلَهَ إِلَّا أَنْتَ سُبْحَانَكَ إِنِّي كُنْتُ مِنَ الظَّالِمِينَ", rumi: "La ilaha illa anta subhanaka inni kuntu minadh-dhalimin.", maksud: "Tiada Tuhan selain Engkau, Maha Suci Engkau, sesungguhnya aku termasuk orang-orang yang zalim." },
            { id: 'kebaikan_dunia', title: "Doa Sapu Jagat (Kebaikan Dunia Akhirat)", arab: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ", rumi: "Rabbana atina fid-dunya hasanatan wa fil-akhirati hasanatan wa qina 'adhaban-nar.", maksud: "Wahai Tuhan kami, berikanlah kami kebaikan di dunia dan kebaikan di akhirat, dan peliharalah kami dari azab neraka." },
            { id: 'ya_hayyu', title: "Doa Ya Hayyu Ya Qayyum", arab: "يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ أَصْلِحْ لِي شَأْنِي كُلَّهُ وَلَا تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ", rumi: "Ya Hayyu Ya Qayyum, bi rahmatika astaghith, aslih li sha'ni kullahu wa la takilni ila nafsi tarfata 'ain.", maksud: "Wahai Tuhan Yang Maha Hidup, Wahai Tuhan Yang Berdiri Sendiri, dengan rahmat-Mu aku memohon pertolongan, perbaikilah segala urusanku dan janganlah Engkau serahkan aku kepada diriku sendiri walau sekelip mata." },
            { id: 'abu_bakar', title: "Doa Saidina Abu Bakar (Mohon Ampunan)", arab: "اللَّهُمَّ إِنِّي ظَلَمْتُ نَفْسِي ظُلْمًا كَثِيرًا وَلَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ فَاغْفِرْ لِي مَغْفِرَةً مِنْ عِنْدِكَ وَارْحَمْنِي إِنَّكَ أَنْتَ الْغَفُورُ الرَّحِيمُ", rumi: "Allahumma inni dhalantu nafsi dhulman kathira, wa la yaghfiru ad-dhunuba illa anta, faghfir li maghfiratan min 'indika warhamni, innaka anta al-ghafuru ar-rahim.", maksud: "Ya Allah, sesungguhnya aku telah menzalimi diriku sendiri dengan kezaliman yang banyak, dan tiada yang dapat mengampuni dosa melainkan Engkau..." },
            { id: 'lindung_penyakit', title: "Doa Lindung Penyakit Berat", arab: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْبَرَصِ وَالْجُنُونِ وَالْجُذَامِ وَمِنْ سَيِّئِ الْأَسْقَامِ", rumi: "Allahumma inni a'udhu bika minal-barasi wal-jununi wal-judhami wa min sayyi'il-asqam.", maksud: "Ya Allah, aku berlindung kepada-Mu dari penyakit sopak (kulit), gila, kusta, dan dari segala penyakit yang buruk." },
            { id: 'mudah_urusan', title: "Doa Dimudahkan Urusan", arab: "اللَّهُمَّ لَا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا وَأَنْتَ تَجْعَلُ الْحَزْنَ إِذَا شِئْتَ سَهْلًا", rumi: "Allahumma la sahla illa ma ja'altahu sahla, wa anta taj'alul-hazna idha shi'ta sahla.", maksud: "Ya Allah, tiada kemudahan kecuali apa yang Engkau jadikan mudah, dan Engkau menjadikan kesedihan (kesulitan) itu mudah jika Engkau menghendaki." },
            { id: 'syukur_ibadah', title: "Doa Kekuatan Syukur & Ibadah", arab: "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِكَ", rumi: "Allahumma a'inni 'ala dhikrika wa shukrika wa husni 'ibadatik.", maksud: "Ya Allah, bantulah aku untuk sentiasa mengingati-Mu, bersyukur kepada-Mu dan memperelokkan ibadahku kepada-Mu." },
            { id: 'lindung_4_perkara', title: "Lindung 4 Perkara (Sebelum Salam)", arab: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ عَذَابِ جَهَنَّمَ وَمِنْ عَذَابِ الْقَبْرِ وَمِنْ فِتْنَةِ الْمَحْيَا وَالْمَمَاتِ وَمِنْ شَرِّ فِتْنَةِ الْمَسِيحِ الدَّجَّالِ", rumi: "Allahumma inni a'uudzu bika min 'adzaabi jahannam, wa min 'adzaabil qabri, wa min fitnatil mahyaa wal mamaat, wa min syarri fitnatil masiihid dajjaal.", maksud: "Ya Allah, aku berlindung kepada-Mu dari azab jahannam, azab kubur, fitnah kehidupan dan kematian, dan dari keburukan fitnah Al-Masih Ad-Dajjal." },
            { id: 'ilmu_rezeki', title: "Mohon Ilmu, Rezeki & Amalan Makbul", arab: "اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا وَرِزْقًا طَيِّبًا وَعَمَلًا مُتَقَبَّلًا", rumi: "Allahumma inni as-aluka 'ilman naafi'an, wa rizqon thoyyiban, wa 'amalan mutaqobbalan.", maksud: "Ya Allah, sesungguhnya aku memohon kepada-Mu ilmu yang bermanfaat, rezeki yang baik dan amal yang diterima." },
            { id: 'ketetapan_hati', title: "Doa Keteguhan Iman", arab: "يَا مُقَلِّبَ الْقُلُوبِ ثَبِّتْ قَلْبِي عَلَى دِينِكَ", rumi: "Ya muqallibal qulub, thabbit qalbi 'ala dinika.", maksud: "Wahai Tuhan yang membolak-balikkan hati, tetapkanlah hatiku di atas agama-Mu." },
            { id: 'pagi_petang', title: "Perlindungan Nama Allah", arab: "بِسْمِ اللَّهِ الَّذِي لَا يَضURُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ", rumi: "Bismillahilladzi laa yadhurru ma'asmihi syai-un fil ardhi walaa fis samaa-i wahuwas samii'ul 'aliim.", maksud: "Dengan nama Allah yang dengan nama-Nya tidak ada sesuatu pun yang dapat memberi bahaya di bumi mahupun di langit, dan Dialah Yang Maha Mendengar lagi Maha Mengetahui." },
            { id: 'husnul_khatimah', title: "Doa Mohon Husnul Khatimah", arab: "اللَّهُمَّ اخْتِمْ لَنَا بِحُسْنِ الْخَاتِمَةِ وَلَا تَخْتِمْ عَلَيْنَا بِسُوءِ الْخَاتِمَةِ", rumi: "Allahummakhtim lana bi husnil khatimah wala takhtim 'alaina bi suu-il khatimah.", maksud: "Ya Allah, akhirilah hidup kami dengan pengakhiran yang baik, dan janganlah Engkau akhiri hidup kami dengan pengakhiran yang buruk." },
            { id: 'kesusahan_hutang', title: "Doa Bebas Hutang & Sedih", arab: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ وَالْعَجْزِ وَالْكَسَلِ وَالْبُخْلِ وَالْجُبْنِ وَضَلَعِ الدَّيْنِ وَغَلَبَةِ الرِّجَالِ", rumi: "Allahumma inni a'uudzu bika minal hammi wal hazan, wal 'ajzi wal kasal, wal bukhli wal jubn, wa dhola'id daini wa gholabatir rijaal.", maksud: "Ya Allah, aku berlindung kepada-Mu dari keluh kesah dan rasa sedih, rasa lemah dan malas, kikir dan penakut, lilitan hutang dan penindasan orang." },
            { id: 'ashabul_kahfi', title: "Doa Rahmat Ashabul Kahfi", arab: "رَبَّنَا آتِنَا مِنْ لَدُنْكَ رَحْمَةً وَهَيِّئْ لَنَا مِنْ أَمْرِنَا رَشَدًا", rumi: "Rabbana aatina min ladunka rahmatan wahayyi' lana min amrinaa rosyada.", maksud: "Wahai Tuhan kami, berikanlah kami rahmat dari sisi-Mu dan sempurnakanlah bagi kami petunjuk yang lurus dalam urusan kami." },
            { id: 'hidayah_taqwa', title: "Doa Mohon Hidayah & Kecukupan", arab: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْهُدَى وَالتُّقَى وَالْعَفَافَ وَالْغِنَى", rumi: "Allahumma inni as-alukal huda wat tuqoo wal 'afafa wal ghina.", maksud: "Ya Allah, sesungguhnya aku memohon kepada-Mu petunjuk, ketaqwaan, sifat menjaga kehormatan diri dan kekayaan (jiwa)." },
            { id: 'ibu_bapa', title: "Doa Kasih Sayang Ibu Bapa", arab: "رَّبِّ اغْفِرْ لِي وَلِوَالِدَيَّ وَارْحَمْهُمَا كَمَا رَبَّيَانِي صَغِيرًا", rumi: "Rabbighfir lii waliwaalidayya warhamhumaa kamaa robbayaanii shoghiroo.", maksud: "Wahai Tuhanku, ampunilah dosaku dan dosa kedua ibu bapaku, dan kasihanilah mereka sebagaimana mereka mendidikku semasa kecil." },
            { id: 'mohon_afiyah', title: "Doa Mohon Keselamatan Penuh ('Afiyah)", arab: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ", rumi: "Allahumma inni as-alukal 'afwa wal 'aafiyata fid dunya wal aakhiroh.", maksud: "Ya Allah, sesungguhnya aku memohon keampunan dan keselamatan (kesejahteraan) di dunia dan di akhirat." }
        ];

        const azanList = [
            { id: 1, name: 'Azan Makkah', author: 'Masjidil Haram', urls: ['https://www.islamcan.com/audio/azan/azan1.mp3', 'https://archive.org/download/AzanMakkah_201904/Azan%20Makkah.mp3'] },
            { id: 2, name: 'Azan Madinah', author: 'Masjid Nabawi', urls: ['https://www.islamcan.com/audio/azan/azan2.mp3', 'https://archive.org/download/AzanMadinah_201904/Azan%20Madinah.mp3'] },
            { id: 3, name: 'Azan Nusantara', author: 'Style Malaysia', urls: ['https://archive.org/download/azan_malaysia/azan_malaysia.mp3', 'https://www.islamcan.com/audio/azan/azan14.mp3'] }
        ];
        
        let selectedAzan = azanList[0];
        const mainPlayer = document.getElementById('main-audio-player');
        const previewPlayer = document.getElementById('preview-audio-player');

        lucide.createIcons();

        // --- MASTER AUDIO UNLOCKING ---
        async function masterUnlock() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                const silentData = "data:audio/wav;base64,UklGRigAAABXQVZRTm9mY2FzdAIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=";
                mainPlayer.src = silentData;
                previewPlayer.src = silentData;
                await mainPlayer.play();
                mainPlayer.pause();
                console.log("Audio Unlocked");
            } catch (e) { console.warn("Unlock failed:", e); }
        }

        function showStatus(msg, isError = false) {
            const el = document.getElementById('audio-status-msg');
            if (el) {
                el.innerText = msg;
                el.style.background = isError ? '#ef4444' : '#d4af37';
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 3000);
            }
        }

        async function toggleAudio() {
            await masterUnlock();
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audio-btn');
            const icon = document.getElementById('audio-icon');
            if(audioEnabled) {
                btn.classList.add('bg-gold/20', 'border-gold');
                icon.setAttribute('data-lucide', 'volume-2');
                icon.classList.replace('text-red-500', 'text-gold');
                showStatus("Sistem Suara Aktif");
            } else {
                btn.classList.remove('bg-gold/20', 'border-gold');
                icon.setAttribute('data-lucide', 'volume-x');
                icon.classList.replace('text-gold', 'text-red-500');
                mainPlayer.pause();
                previewPlayer.pause();
            }
            lucide.createIcons();
        }

        async function safePlay(player, urls) {
            if (!audioEnabled) return;
            for (let url of urls) {
                try {
                    player.src = url;
                    player.load();
                    await player.play();
                    return true;
                } catch (e) {}
            }
            return false;
        }

        function playSound(type, freq = 440) {
            if (!audioEnabled) return;
            if (type === 'beep') {
                try {
                    const osc = audioCtx.createOscillator();
                    const gn = audioCtx.createGain();
                    osc.connect(gn); gn.connect(audioCtx.destination);
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    gn.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gn.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.5);
                } catch(e) {}
            } else { safePlay(mainPlayer, selectedAzan.urls); }
        }

        // --- PRAYER COLLECTION LOGIC ---
        function openPrayerCollection() {
            masterUnlock();
            const list = document.getElementById('prayer-collection-list');
            list.innerHTML = prayerCollection.map(p => `
                <div class="p-4 rounded-2xl glass-panel border-white/5 hover:border-gold/50 transition-all cursor-pointer group flex items-center gap-4 bg-black/20" onclick="viewDetailedDua('${p.id}')">
                    <div class="w-10 h-10 rounded-xl bg-gold/10 flex items-center justify-center border border-gold/20">
                        <i data-lucide="sparkles" class="w-5 h-5 text-gold"></i>
                    </div>
                    <div class="flex-1">
                        <span class="text-sm font-bold text-white group-hover:text-gold transition-colors block leading-tight uppercase tracking-tight">${p.title}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-700"></i>
                </div>
            `).join('');
            document.getElementById('collection-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function viewDetailedDua(id) {
            const data = prayerCollection.find(p => p.id === id);
            closeCollectionModal();
            const content = document.getElementById('dua-content');
            content.innerHTML = `
                <div class="inline-block px-6 py-2 rounded-full bg-gold/10 text-gold text-[9px] font-black uppercase border border-gold/20 mb-8">${data.title}</div>
                <div class="arabic-text mb-10">${data.arab}</div>
                <div class="bg-black/60 rounded-[2.5rem] p-6 border border-gold/10 space-y-6 text-left">
                    <div>
                        <p class="text-[9px] text-gold font-black uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="languages" class="w-3 h-3"></i> Sebutan Rumi</p>
                        <p class="text-sm font-bold text-slate-200 italic leading-relaxed">"${data.rumi}"</p>
                    </div>
                    <div class="border-t border-white/5 pt-5">
                        <p class="text-[9px] text-gold font-black uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="info" class="w-3 h-3"></i> Terjemahan</p>
                        <p class="text-[11px] text-slate-400 font-medium leading-relaxed">${data.maksud}</p>
                    </div>
                </div>
            `;
            document.getElementById('dua-modal').style.display = 'flex';
            document.getElementById('tts-btn').onclick = () => speakDua(data.rumi);
            lucide.createIcons();
        }

        function closeCollectionModal() { document.getElementById('collection-modal').style.display = 'none'; }
        function closeModal() { document.getElementById('dua-modal').style.display = 'none'; }

        async function speakDua(text) {
            const btn = document.getElementById('tts-btn');
            const old = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="loading-dots italic font-black text-black uppercase">Analisis Suara</span>`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Say this clearly in a professional and calm spiritual tone: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } } })
                });
                const res = await response.json();
                const audioData = res.candidates[0].content.parts[0].inlineData.data;
                const blob = pcmToWav(audioData, 24000);
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                audio.onended = () => { btn.innerHTML = old; btn.disabled = false; };
            } catch (e) { btn.innerHTML = old; btn.disabled = false; }
        }

        function pcmToWav(base64, rate) {
            const buffer = Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;
            const wav = new Uint8Array(44 + buffer.byteLength);
            const view = new DataView(wav.buffer);
            view.setUint32(0, 0x52494646, false); view.setUint32(4, 36 + buffer.byteLength, true); view.setUint32(8, 0x57415645, false);
            view.setUint32(12, 0x666d7420, false); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, rate, true); view.setUint32(28, rate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); view.setUint32(36, 0x64617461, false); view.setUint32(40, buffer.byteLength, true);
            new Uint8Array(wav.buffer, 44).set(new Uint8Array(buffer)); return new Blob([wav], { type: 'audio/wav' });
        }

        function openDua(type) {
            const duaData = {
                berbuka_sendiri: { title: "Doa Berbuka (Individu)", arab: "اللَّهُمَّ لَكَ صُمْتُ وَبِكَ آمَنْتُ وَعَلَى رِزْقِكَ أَفْطَرْتُ", rumi: "Allahumma laka sumtu wa bika amantu wa 'ala rizqika aftartu", maksud: "Ya Allah, bagi-Mu aku berpuasa dan dengan-Mu aku beriman dan atas rezeki-Mu aku berbuka." },
                berbuka_ramai: { title: "Doa Berbuka (Berjemaah)", arab: "اللَّهُمَّ لَكَ صُمْنَا وَبِكَ آمَنَّا وَعَلَى رِزْقِكَ أَفْطَرْنَا", rumi: "Allahumma laka sumna wa bika amanna wa 'ala rizqika aftarna", maksud: "Ya Allah, bagi-Mu kami berpuasa dan dengan-Mu kami beriman dan atas rezeki-Mu kami berbuka." },
                niat_puasa: { title: "Niat Puasa Ramadan", arab: "نَوَيْتُ صَوْمَ غَدٍ عَنْ أَدَاءِ فَرْضِ شَهْرِ رَمَضَانَ هَذِهِ السَّنَةِ لِلَّهِ تَعَالَى", rumi: "Nawaitu sauma ghadin 'an ada'i fardi shahri Ramadhana hazihis sanati lillahi Ta'ala", maksud: "Sahaja aku berpuasa esok hari bagi menunaikan fardu bulan Ramadan tahun ini kerana Allah Ta'ala." }
            };
            masterUnlock();
            const data = duaData[type];
            document.getElementById('dua-content').innerHTML = `
                <div class="inline-block px-6 py-2 rounded-full bg-gold/10 text-gold text-[9px] font-black uppercase border border-gold/20 mb-6">${data.title}</div>
                <div class="arabic-text mb-10">${data.arab}</div>
                <div class="bg-black/60 rounded-[2.5rem] p-6 border border-gold/10 space-y-4">
                    <p class="text-sm font-bold text-gold italic text-center">"${data.rumi}"</p>
                    <p class="text-[10px] text-slate-500 font-black uppercase text-center tracking-tight">${data.maksud}</p>
                </div>
            `;
            document.getElementById('dua-modal').style.display = 'flex';
            document.getElementById('tts-btn').onclick = () => speakDua(data.rumi);
            lucide.createIcons();
        }

        // --- INITIALIZATION ---
        function selectLocation(lat, lon, district, state) {
            Object.keys(prayerNames).forEach(key => { window[`a30_${key}`] = false; window[`a15_${key}`] = false; window[`a0_${key}`] = false; });
            locationData = { lat: parseFloat(lat), lon: parseFloat(lon), district, state };
            document.getElementById('location-district').innerText = district;
            document.getElementById('location-state').innerText = state;
            document.getElementById('search-results').classList.add('hidden');
            fetchPrayerTimes();
        }
        window.selectLocation = selectLocation;

        async function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&addressdetails=1`);
                        const data = await res.json();
                        const addr = data.address;
                        const district = addr.city || addr.town || addr.district || addr.county || "Daerah";
                        selectLocation(pos.coords.latitude, pos.coords.longitude, district, addr.state || "Malaysia");
                    } catch (e) { selectLocation(3.1390, 101.6869, "Kuala Lumpur", "W. Persekutuan"); }
                }, () => selectLocation(3.1390, 101.6869, "Kuala Lumpur", "W. Persekutuan"));
            }
        }

        async function fetchPrayerTimes() {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now()/1000)}?latitude=${locationData.lat}&longitude=${locationData.lon}&method=11`);
                const data = await res.json();
                let timings = data.data.timings;
                
                const syurukParts = timings.Sunrise.split(':').map(Number);
                let duhaDate = new Date(); duhaDate.setHours(syurukParts[0], syurukParts[1] + 28, 0);
                timings.Duha = duhaDate.getHours().toString().padStart(2, '0') + ":" + duhaDate.getMinutes().toString().padStart(2, '0');

                const fajrParts = timings.Fajr.split(':').map(Number);
                let tahajjudDate = new Date(); tahajjudDate.setHours(fajrParts[0] - 3, fajrParts[1], 0);
                timings.Tahajjud = tahajjudDate.getHours().toString().padStart(2, '0') + ":" + tahajjudDate.getMinutes().toString().padStart(2, '0');

                prayerTimes = timings;
                renderTimeline();
            } catch (e) {}
        }

        function renderTimeline() {
            const list = document.getElementById('prayer-list');
            if (!list) return;
            list.innerHTML = '';
            Object.keys(prayerNames).forEach(key => {
                list.innerHTML += `
                    <div id="card-${key}" class="glass-panel card-${key} rounded-[1.5rem] p-5 flex justify-between items-center border border-gold/10">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-black/40 rounded-xl flex items-center justify-center border border-gold/20"><i data-lucide="${getIcon(key)}" class="text-gold w-5 h-5"></i></div>
                            <span class="font-bold text-slate-300 text-[10px] uppercase">${prayerNames[key]}</span>
                        </div>
                        <span class="text-2xl font-bold font-mono text-white">${prayerTimes[key]}</span>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function getIcon(key) { return { 'Imsak':'moon','Fajr':'sunrise','Sunrise':'sun','Duha':'sun-medium','Dhuhr':'sun','Asr':'cloud-sun','Maghrib':'sunset','Isha':'moon-star', 'Tahajjud': 'sparkles' }[key] || 'clock'; }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ms-MY', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            if (document.getElementById('real-time-clock')) document.getElementById('real-time-clock').innerHTML = formatColorfulTime(timeStr);
            if (!prayerTimes) return;
            
            let nextKey = null; let currentActive = null; let minDiff = Infinity;
            Object.keys(prayerNames).forEach(key => {
                const [h, m] = prayerTimes[key].split(':').map(Number);
                const pDate = new Date(); pDate.setHours(h, m, 0, 0);
                if (key === 'Tahajjud' && pDate.getHours() > 12 && now.getHours() < 12) pDate.setDate(pDate.getDate() - 1);
                const diff = pDate - now; const diffMins = Math.floor(diff / 60000);

                if (diffMins === 30 && !window[`a30_${key}`]) { playSound('beep', 440); window[`a30_${key}`] = true; }
                if (diffMins === 15 && !window[`a15_${key}`]) { playSound('beep', 880); window[`a15_${key}`] = true; }
                if (diffMins === 0 && !window[`a0_${key}`]) { playSound('azan'); window[`a0_${key}`] = true; }

                if (diff > 0 && diff < minDiff) { minDiff = diff; nextKey = key; }
                if (diff <= 0) currentActive = key;
            });

            if (nextKey) {
                const maghrib = new Date(); const [mh, mm] = prayerTimes['Maghrib'].split(':').map(Number); maghrib.setHours(mh, mm, 0, 0);
                updateVisualTheme(now.getHours(), maghrib - now, currentActive);
                document.getElementById('next-time').innerText = prayerTimes[nextKey];
                const h = Math.floor(minDiff / 3600000); const m = Math.floor((minDiff % 3600000) / 60000); const s = Math.floor((minDiff % 60000) / 1000);
                document.getElementById('countdown').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
        }

        function formatColorfulTime(timeStr) {
            return timeStr.split('').map((char, i) => {
                if (char === ':') return `<span class="text-gold/20 mx-0.5">:</span>`;
                return `<span class="colorful-digit" style="color: ${clockColors[(Math.floor(Date.now()/1000) + i) % clockColors.length]}">${char}</span>`;
            }).join('');
        }

        function updateVisualTheme(hour, diffToIftar, currentActive) {
            const card = document.getElementById('main-timer-card'); if (!card) return;
            card.classList.remove('mood-dawn', 'mood-morning', 'mood-midday', 'mood-afternoon', 'mood-sunset', 'mood-night');
            if (diffToIftar < 1800000 && diffToIftar > 0) card.classList.add('mood-sunset');
            else if (hour >= 4 && hour < 6) card.classList.add('mood-dawn');
            else if (hour >= 6 && hour < 10) card.classList.add('mood-morning');
            else if (hour >= 10 && hour < 15) card.classList.add('mood-midday');
            else if (hour >= 15 && hour < 18) card.classList.add('mood-afternoon');
            else card.classList.add('mood-night');
            document.querySelectorAll('[id^="card-"]').forEach(el => el.classList.remove('denyut-aktif'));
            const active = document.getElementById(`card-${currentActive}`); if (active) active.classList.add('denyut-aktif');
        }

        function incrementTasbih() { tasbihCount++; document.getElementById('tasbih-count').innerText = tasbihCount; playSound('beep', 1000); }
        function resetTasbih() { tasbihCount = 0; document.getElementById('tasbih-count').innerText = 0; }
        function closeTasbih() { document.getElementById('tasbih-modal').style.display = 'none'; }
        function openTasbih() { masterUnlock(); document.getElementById('tasbih-modal').style.display = 'flex'; }
        function closeAzanModal() { previewPlayer.pause(); document.getElementById('azan-modal').style.display = 'none'; }
        function openAzanSelector() {
            masterUnlock();
            const list = document.getElementById('azan-options-list');
            list.innerHTML = azanList.map(azan => `
                <div class="flex items-center justify-between p-4 rounded-xl glass-panel ${selectedAzan.id === azan.id ? 'border-gold bg-gold/5' : 'border-white/5'}">
                    <div><div class="text-sm font-black text-white uppercase">${azan.name}</div><div class="text-[9px] text-slate-500 uppercase font-bold">${azan.author}</div></div>
                    <div class="flex gap-2">
                        <button onclick="testAzan(${azan.id}, this)" class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-emerald-400 active:scale-90"><i data-lucide="play" class="w-4 h-4"></i></button>
                        <button onclick="setAzan(${azan.id})" class="px-5 py-2 rounded-xl ${selectedAzan.id === azan.id ? 'bg-gold text-black' : 'bg-slate-800 text-slate-400'} text-[10px] font-black uppercase">Pilih</button>
                    </div>
                </div>`).join('');
            document.getElementById('azan-modal').style.display = 'flex';
            lucide.createIcons();
        }
        function setAzan(id) { selectedAzan = azanList.find(a => a.id === id); openAzanSelector(); }
        function testAzan(id, btn) {
            const azan = azanList.find(a => a.id === id);
            if (previewPlayer.paused || previewPlayer.src !== azan.urls[0]) { safePlay(previewPlayer, azan.urls); btn.innerHTML = '<i data-lucide="pause" class="w-4 h-4 text-orange-400"></i>'; }
            else { previewPlayer.pause(); btn.innerHTML = '<i data-lucide="play" class="w-4 h-4 text-emerald-400"></i>'; }
            lucide.createIcons();
        }

        // --- SEARCH LOGIC ---
        const locInput = document.getElementById('location-input');
        const sResults = document.getElementById('search-results');
        locInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 3) { sResults.classList.add('hidden'); return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)} Malaysia&limit=5&addressdetails=1`);
                    const data = await res.json();
                    sResults.innerHTML = data.map(i => {
                        const name = i.address.city || i.address.town || i.address.district || i.display_name.split(',')[0];
                        return `<div class="px-8 py-5 hover:bg-white/5 cursor-pointer border-b border-gold/10 transition-all" onclick="window.selectLocation('${i.lat}', '${i.lon}', '${name.replace(/'/g, "")}', '${i.address.state || 'Malaysia'}')">
                            <div class="text-sm font-bold text-white/90 uppercase">${name}</div>
                            <div class="text-[9px] text-gold mt-1">${i.address.state || 'Malaysia'}</div>
                        </div>`;
                    }).join('');
                    sResults.classList.remove('hidden');
                } catch (err) { console.error(err); }
            }, 600);
        });

        initLocation();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>